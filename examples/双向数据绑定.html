<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>双向数据绑定</title>
  </head>
  <body>
    <!--
    Vue里面的数据绑定是通过数据劫持的方式来实现的，其中最核心的便是Object.defineProperty()，不熟悉这个方法的，建议先去学习一下相关的内容，这里就不再赘述。

    双向数据绑定，简单点来说分为三个部分：
    1、Observer。这里的主要工作是递归地监听对象上的所有属性，在属性值改变的时候，触发相应的watcher。
    2、Watcher。观察者，当监听的数据值修改时，执行响应的回调函数（Vue里面的更新模板内容）。
    3、Dep。连接Observer和Watcher的桥梁，每一个Observer对应一个Dep，它内部维护一个数组，保存与该Observer相关的Watcher。
    -->
    <div id="app"></div>
    <script>
      var obj = {
        a: 1,
        b: 2,
        c: 3,
        d: {
          a: {
            b: 1
          }
        }
      }
      Object.keys(obj).forEach(function (key) {
        new Observer(obj, key, obj[key])
      })

      new Watcher(function () {
        document.querySelector('#app').innerHTML = obj.a
      })

      function Observer(obj, key, value) {
        var dep = new Dep()
        if (Object.prototype.toString.call(value) == '[object Object]') {
          Object.keys(value).forEach(function (key) {
            new Observer(value, key, value[key])
          })
        }
        Object.defineProperty(obj, key, {
          enumerable: true,
          configurable: true,
          get: function () {
            console.log(`获取属性${key},值为${value}`)
            if (Dep.target) {
              dep.addSub(Dep.target)
            }
            return value
          },
          set: function (newVal) {
            console.log(`设置属性${key},值为${newVal}`)
            value = newVal
            dep.notify()
          }
        })
      }

      function Watcher(fn) {
        this.update = function () {
          Dep.target = this
          fn()
          Dep.target = null
        }
        this.update()
      }

      function Dep() {
        this.subs = []
        this.addSub = function (watcher) {
          this.subs.push(watcher)
        }
        this.notify = function () {
          this.subs.forEach(function (watcher) {
            watcher.update()
          })
        }
      }
    </script>
  </body>
</html>
